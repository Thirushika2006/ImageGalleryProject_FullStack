<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Gallery</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; }
        .navbar {
            background: #2c3e50; color: white;
            padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .navbar h1 { font-size: 20px; }
        .nav-right { display: flex; gap: 10px; align-items: center; }
        .nav-right span { font-size: 14px; color: #aaa; }
        .nav-btn { color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-profile { background: #3498db; }
        .btn-profile:hover { background: #2980b9; }
        .btn-trash { background: #7f8c8d; }
        .btn-trash:hover { background: #636e72; }
        .btn-admin { background: #e67e22; display: none; }
        .btn-admin:hover { background: #d35400; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .upload-section { background: white; margin: 20px 30px; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .upload-section h3 { margin-bottom: 15px; color: #333; }
        .upload-row { display: flex; gap: 10px; align-items: center; }
        input[type="file"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .upload-btn { padding: 8px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .search-section { margin: 0 30px 15px; display: flex; gap: 10px; align-items: center; }
        .search-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .search-input:focus { border-color: #3498db; }
        .search-btn { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .clear-btn { padding: 10px 15px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .gallery-section { margin: 0 30px 20px; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gallery-header h3 { color: #333; }
        .result-count { font-size: 13px; color: #888; }
        .gallery { display: flex; flex-wrap: wrap; gap: 15px; }
        .image-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); width: 220px; overflow: hidden; transition: transform 0.2s; }
        .image-card:hover { transform: translateY(-3px); }
        .image-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .card-body { padding: 12px; }
        .img-name { font-weight: bold; font-size: 13px; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta { font-size: 11px; color: #888; margin-bottom: 8px; }
        .rename-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .rename-row input { flex: 1; padding: 5px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-row { display: flex; gap: 5px; }
        .btn { flex: 1; padding: 6px 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-rename { background: #3498db; color: white; }
        .btn-download { background: #9b59b6; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 30px 30px; flex-wrap: wrap; }
        .page-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .page-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .page-btn:hover { background: #3498db; color: white; }
        .page-info { font-size: 14px; color: #666; }
        .empty-msg { color: #888; font-style: italic; margin-top: 20px; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #2c3e50; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; display: none; z-index: 999; }
    </style>
</head>
<body>

<div class="navbar">
    <h1>üñºÔ∏è My Image Gallery</h1>
    <div class="nav-right">
        <span id="welcomeMsg">Welcome!</span>
        <button class="nav-btn btn-profile" onclick="window.location.href='/profile.html'">üë§ Profile</button>
        <button class="nav-btn btn-trash" onclick="window.location.href='/trash.html'">üóëÔ∏è Trash</button>
        <button class="nav-btn btn-admin" id="adminBtn" onclick="window.location.href='/admin.html'">üëë Admin</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<div class="upload-section">
    <h3>üì§ Upload Image</h3>
    <div class="upload-row">
        <input type="file" id="fileInput" accept="image/*">
        <button class="upload-btn" onclick="uploadImage()">Upload</button>
    </div>
</div>

<div class="search-section">
    <input type="text" class="search-input" id="searchInput"
        placeholder="üîç Search images by name..."
        onkeydown="if(event.key==='Enter') searchImages()">
    <button class="search-btn" onclick="searchImages()">Search</button>
    <button class="clear-btn" onclick="clearSearch()">Clear</button>
</div>

<div class="gallery-section">
    <div class="gallery-header">
        <h3>üóÇÔ∏è My Images</h3>
        <span class="result-count" id="resultCount"></span>
    </div>
    <div class="gallery" id="gallery"></div>
</div>

<div class="pagination" id="pagination"></div>
<div class="toast" id="toast"></div>

<script>
const apiBase = '/api/images';
let currentPage = 0;
let totalPages = 0;
let currentSearch = '';
const pageSize = 6;

function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.innerText = msg; toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 3000);
}
function formatSize(bytes) {
    if (!bytes) return '';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}
function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
async function loadUsername() {
    try {
        const res = await fetch('/api/auth/me');
        const name = await res.text();
        document.getElementById('welcomeMsg').innerText = 'Welcome, ' + name + '!';
        const roleRes = await fetch('/api/auth/role');
        const role = await roleRes.text();
        if (role === 'ADMIN') document.getElementById('adminBtn').style.display = 'block';
    } catch(e) {}
}
async function loadImages(page = 0) {
    try {
        const url = `${apiBase}?page=${page}&size=${pageSize}&search=${encodeURIComponent(currentSearch)}`;
        const res = await fetch(url);
        if (res.status === 401) { window.location.href = '/login.html'; return; }
        const data = await res.json();
        const images = data.images;
        currentPage = data.currentPage;
        totalPages = data.totalPages;
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = '';
        document.getElementById('resultCount').innerText =
            data.totalItems > 0 ? `${data.totalItems} image(s) found` : '';
        if (images.length === 0) {
            gallery.innerHTML = '<p class="empty-msg">' +
                (currentSearch ? 'No images found for "' + currentSearch + '"' : 'No images uploaded yet.') + '</p>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        images.forEach(image => {
            const card = document.createElement('div');
            card.className = 'image-card';

            const img = document.createElement('img');
            // ‚úÖ image.path is now full Cloudinary URL
            img.src = image.path;
            img.alt = image.name;
            img.onerror = () => { img.src = 'https://placehold.co/220x150?text=No+Preview'; };

            const body = document.createElement('div');
            body.className = 'card-body';
            const nameEl = document.createElement('div');
            nameEl.className = 'img-name';
            nameEl.title = image.name;
            nameEl.innerText = image.name;
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerText = `${formatSize(image.fileSize)} ‚Ä¢ ${formatDate(image.uploadTime)}`;
            const renameRow = document.createElement('div');
            renameRow.className = 'rename-row';
            const renameInput = document.createElement('input');
            renameInput.type = 'text';
            renameInput.placeholder = 'New name...';
            renameInput.id = `rename-${image.id}`;
            const renameBtn = document.createElement('button');
            renameBtn.className = 'btn btn-rename';
            renameBtn.innerText = '‚úèÔ∏è';
            renameBtn.onclick = () => renameImage(image.id);
            renameRow.appendChild(renameInput);
            renameRow.appendChild(renameBtn);
            const btnRow = document.createElement('div');
            btnRow.className = 'btn-row';
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-download';
            downloadBtn.innerText = '‚¨á Download';
            // ‚úÖ Download directly from Cloudinary URL
            downloadBtn.onclick = () => downloadImage(image.id, image.name, image.path);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-delete';
            deleteBtn.innerText = 'üóë Delete';
            deleteBtn.onclick = () => deleteImage(image.id);
            btnRow.appendChild(downloadBtn);
            btnRow.appendChild(deleteBtn);
            body.appendChild(nameEl);
            body.appendChild(meta);
            body.appendChild(renameRow);
            body.appendChild(btnRow);
            card.appendChild(img);
            card.appendChild(body);
            gallery.appendChild(card);
        });
        buildPagination();
    } catch (err) {
        console.error('Failed to load images:', err);
        showToast('Error loading images');
    }
}
function buildPagination() {
    const pag = document.getElementById('pagination');
    pag.innerHTML = '';
    if (totalPages <= 1) return;
    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.innerText = '‚Üê Prev';
    prev.disabled = currentPage === 0;
    prev.onclick = () => loadImages(currentPage - 1);
    pag.appendChild(prev);
    for (let i = 0; i < totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
        btn.innerText = i + 1;
        btn.onclick = () => loadImages(i);
        pag.appendChild(btn);
    }
    const next = document.createElement('button');
    next.className = 'page-btn';
    next.innerText = 'Next ‚Üí';
    next.disabled = currentPage === totalPages - 1;
    next.onclick = () => loadImages(currentPage + 1);
    pag.appendChild(next);
    const info = document.createElement('span');
    info.className = 'page-info';
    info.innerText = `Page ${currentPage + 1} of ${totalPages}`;
    pag.appendChild(info);
}
function searchImages() {
    currentSearch = document.getElementById('searchInput').value.trim();
    loadImages(0);
}
function clearSearch() {
    currentSearch = '';
    document.getElementById('searchInput').value = '';
    loadImages(0);
}
async function uploadImage() {
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files[0]) { showToast('Please select a file first!'); return; }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        showToast('Uploading to cloud...');
        const res = await fetch(`${apiBase}/upload`, { method: 'POST', body: formData });
        if (res.status === 401) { window.location.href = '/login.html'; return; }
        const data = await res.text();
        showToast(data);
        fileInput.value = '';
        loadImages(0);
    } catch (err) { showToast('Upload failed!'); }
}
async function deleteImage(id) {
    if (!confirm('Move this image to trash?')) return;
    try {
        const res = await fetch(`${apiBase}/delete/${id}`, { method: 'DELETE' });
        showToast(await res.text());
        loadImages(currentPage);
    } catch (err) { showToast('Delete failed!'); }
}
async function renameImage(id) {
    const input = document.getElementById(`rename-${id}`);
    const newName = input.value.trim();
    if (!newName) { showToast('Enter a new name first'); return; }
    try {
        const res = await fetch(`${apiBase}/rename/${id}?newName=${encodeURIComponent(newName)}`, { method: 'PUT' });
        showToast(await res.text());
        loadImages(currentPage);
    } catch (err) { showToast('Rename failed!'); }
}
// ‚úÖ Download directly from Cloudinary URL
function downloadImage(id, name, cloudinaryUrl) {
    const link = document.createElement('a');
    link.href = cloudinaryUrl;
    link.download = name;
    link.target = '_blank';
    link.click();
}
async function logout() {
    try { await fetch('/api/auth/logout', { method: 'POST' }); } catch(e) {}
    window.location.href = '/login.html';
}
loadUsername();
loadImages(0);
</script>
</body>
</html>